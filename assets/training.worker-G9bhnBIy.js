(function(){"use strict";class P{constructor(t=42){this.seed=t,this.state=t}_next(){this.state|=0,this.state=this.state+1831565813|0;let t=Math.imul(this.state^this.state>>>15,1|this.state);return t=t+Math.imul(t^t>>>7,61|t)^t,((t^t>>>14)>>>0)/4294967296}random(){return this._next()}gauss(t=0,a=1){const e=this._next(),s=this._next(),n=Math.sqrt(-2*Math.log(e))*Math.cos(2*Math.PI*s);return t+a*n}shuffle(t){for(let a=t.length-1;a>0;a--){const e=Math.floor(this._next()*(a+1));[t[a],t[e]]=[t[e],t[a]]}return t}weightedChoice(t,a){const e=a.reduce((n,o)=>n+o,0);let s=this._next()*e;for(let n=0;n<t.length;n++)if(s-=a[n],s<=0)return t[n];return t[t.length-1]}}class h{constructor(t,a=[],e=[]){this.data=t,this.grad=0,this._children=a,this._localGrads=e}add(t){return t instanceof h||(t=new h(t)),new h(this.data+t.data,[this,t],[1,1])}mul(t){return t instanceof h||(t=new h(t)),new h(this.data*t.data,[this,t],[t.data,this.data])}pow(t){return new h(this.data**t,[this],[t*this.data**(t-1)])}log(){return new h(Math.log(this.data),[this],[1/this.data])}exp(){return new h(Math.exp(this.data),[this],[Math.exp(this.data)])}relu(){return new h(Math.max(0,this.data),[this],[this.data>0?1:0])}neg(){return this.mul(-1)}sub(t){return t instanceof h||(t=new h(t)),this.add(t.neg())}div(t){return t instanceof h||(t=new h(t)),this.mul(t.pow(-1))}backward(){const t=[],a=new Set,e=s=>{if(!a.has(s)){a.add(s);for(const n of s._children)e(n);t.push(s)}};e(this),this.grad=1;for(const s of t.reverse())for(let n=0;n<s._children.length;n++)s._children[n].grad+=s._localGrads[n]*s.grad}}function v(c){let t=c[0];for(let a=1;a<c.length;a++)t=t.add(c[a]);return t}function y(c,t){return t.map(a=>v(a.map((e,s)=>e.mul(c[s]))))}function _(c){const t=Math.max(...c.map(s=>s.data)),a=c.map(s=>s.sub(new h(t)).exp()),e=v(a);return a.map(s=>s.div(e))}function H(c){const a=v(c.map(e=>e.mul(e))).div(new h(c.length)).add(new h(1e-5)).pow(-.5);return c.map(e=>e.mul(a))}function q(c,t,a,e,s,n){const{nEmbd:o,nHead:p,nLayer:S,headDim:m}=n;let z=s.wte[c],x=s.wpe[t],r=z.map((i,l)=>i.add(x[l]));r=H(r);const b={embedding:r.map(i=>i.data),attentionWeights:[],mlpActivations:[]};for(let i=0;i<S;i++){const l=r;r=H(r);const w=y(r,s[`layer${i}.attn_wq`]),k=y(r,s[`layer${i}.attn_wk`]),$=y(r,s[`layer${i}.attn_wv`]);a[i].push(k),e[i].push($);const L=[],M=[];for(let g=0;g<p;g++){const f=g*m,T=w.slice(f,f+m),j=a[i].map(u=>u.slice(f,f+m)),G=e[i].map(u=>u.slice(f,f+m)),N=j.map(u=>v(T.map((O,R)=>O.mul(u[R]))).div(new h(Math.sqrt(m)))),B=_(N);M.push(B.map(u=>u.data));const I=[];for(let u=0;u<m;u++)I.push(v(G.map((O,R)=>B[R].mul(O[u]))));L.push(...I)}b.attentionWeights.push(M),r=y(L,s[`layer${i}.attn_wo`]),r=r.map((g,f)=>g.add(l[f]));const C=r;r=H(r),r=y(r,s[`layer${i}.mlp_fc1`]),b.mlpActivations.push(r.map(g=>g.data)),r=r.map(g=>g.relu()),r=y(r,s[`layer${i}.mlp_fc2`]),r=r.map((g,f)=>g.add(C[f]))}return{logits:y(r,s.lm_head),vizData:b}}class W{constructor(t={}){this.rng=new P(t.seed??42),this.config={nEmbd:t.nEmbd??16,nHead:t.nHead??4,nLayer:t.nLayer??1,blockSize:t.blockSize??16},this.config.headDim=this.config.nEmbd/this.config.nHead,this.learningRate=t.learningRate??.01,this.beta1=.85,this.beta2=.99,this.epsAdam=1e-8,this.numSteps=t.numSteps??1e3,this.docs=[],this.uchars=[],this.BOS=0,this.vocabSize=0,this.stateDict={},this.params=[],this.m=[],this.v=[],this.step=0,this.lossHistory=[],this.initialized=!1}loadData(t){this.docs=t.split(`
`).map(e=>e.trim()).filter(e=>e.length>0),this.rng.shuffle(this.docs);const a=new Set(this.docs.join(""));this.uchars=[...a].sort(),this.BOS=this.uchars.length,this.vocabSize=this.uchars.length+1}_matrix(t,a,e=.08){return Array.from({length:t},()=>Array.from({length:a},()=>new h(this.rng.gauss(0,e))))}initParams(){const{nEmbd:t,nLayer:a,blockSize:e}=this.config;this.stateDict={wte:this._matrix(this.vocabSize,t),wpe:this._matrix(e,t),lm_head:this._matrix(this.vocabSize,t)};for(let s=0;s<a;s++)this.stateDict[`layer${s}.attn_wq`]=this._matrix(t,t),this.stateDict[`layer${s}.attn_wk`]=this._matrix(t,t),this.stateDict[`layer${s}.attn_wv`]=this._matrix(t,t),this.stateDict[`layer${s}.attn_wo`]=this._matrix(t,t),this.stateDict[`layer${s}.mlp_fc1`]=this._matrix(4*t,t),this.stateDict[`layer${s}.mlp_fc2`]=this._matrix(t,4*t);this.params=[];for(const s of Object.values(this.stateDict))for(const n of s)for(const o of n)this.params.push(o);return this.m=new Array(this.params.length).fill(0),this.v=new Array(this.params.length).fill(0),this.step=0,this.lossHistory=[],this.initialized=!0,{numParams:this.params.length,vocabSize:this.vocabSize,numDocs:this.docs.length}}trainStep(){if(!this.initialized)throw new Error("Not initialized. Call loadData() and initParams() first.");const{nLayer:t,blockSize:a}=this.config,e=this.step,s=this.docs[e%this.docs.length],n=[this.BOS,...s.split("").map(i=>this.uchars.indexOf(i)),this.BOS],o=Math.min(a,n.length-1),p=Array.from({length:t},()=>[]),S=Array.from({length:t},()=>[]),m=[],z=[];for(let i=0;i<o;i++){const l=n[i],w=n[i+1],{logits:k,vizData:$}=q(l,i,p,S,this.stateDict,this.config),M=_(k)[w].log().neg();m.push(M),z.push($)}const x=v(m).mul(new h(1/o));x.backward();const r=Math.max(0,this.learningRate*(1-e/this.numSteps));for(let i=0;i<this.params.length;i++){const l=this.params[i];this.m[i]=this.beta1*this.m[i]+(1-this.beta1)*l.grad,this.v[i]=this.beta2*this.v[i]+(1-this.beta2)*l.grad**2;const w=this.m[i]/(1-this.beta1**(e+1)),k=this.v[i]/(1-this.beta2**(e+1));l.data-=r*w/(Math.sqrt(k)+this.epsAdam),l.grad=0}this.step++;const b=x.data;this.lossHistory.push(b);const D={mean:this.params.reduce((i,l)=>i+l.data,0)/this.params.length,std:Math.sqrt(this.params.reduce((i,l)=>i+l.data**2,0)/this.params.length)};return{step:this.step,loss:b,doc:s,tokens:n,learningRate:r,paramStats:D,vizData:z}}generate(t=.5){if(!this.initialized)throw new Error("Not initialized.");const{nLayer:a,blockSize:e}=this.config,s=Array.from({length:a},()=>[]),n=Array.from({length:a},()=>[]);let o=this.BOS;const p=[],S=[];for(let m=0;m<e;m++){const{logits:z,vizData:x}=q(o,m,s,n,this.stateDict,this.config),r=z.map(l=>l.div(new h(t))),b=_(r),D=Array.from({length:this.vocabSize},(l,w)=>w),i=b.map(l=>l.data);if(o=this.rng.weightedChoice(D,i),S.push({...x,probs:i}),o===this.BOS)break;p.push(this.uchars[o])}return{text:p.join(""),tokens:p.map(m=>this.uchars.indexOf(m)),vizData:S}}getLossHistory(){return[...this.lossHistory]}getEmbeddings(){return this.stateDict.wte.map((t,a)=>({tokenId:a,char:a<this.uchars.length?this.uchars[a]:"<BOS>",embedding:t.map(e=>e.data)}))}getConfig(){return{...this.config,vocabSize:this.vocabSize,numDocs:this.docs.length}}}let d=null,A=!1,E=!1;self.onmessage=async function(c){const{type:t,payload:a}=c.data;switch(t){case"init":{d=new W(a.options||{}),d.loadData(a.text);const e=d.initParams();self.postMessage({type:"initialized",payload:e});break}case"train":{if(!d||A)return;A=!0,E=!1;const e=a.steps||100,s=a.reportEvery||1;d.numSteps=d.step+e;for(let n=0;n<e&&!E;n++){const o=d.trainStep();((n+1)%s===0||n===e-1)&&self.postMessage({type:"trainStep",payload:{step:o.step,loss:o.loss,doc:o.doc,learningRate:o.learningRate,paramStats:o.paramStats,attentionWeights:o.vizData.length>0?o.vizData[o.vizData.length-1].attentionWeights:null,embedding:o.vizData.length>0?o.vizData[o.vizData.length-1].embedding:null}}),n%5===0&&await new Promise(p=>setTimeout(p,0))}A=!1,self.postMessage({type:"trainDone",payload:{totalSteps:d.step}});break}case"stop":{E=!0;break}case"generate":{if(!d)return;const e=a.temperature||.5,s=a.numSamples||10,n=[];for(let o=0;o<s;o++){const p=d.generate(e);n.push(p)}self.postMessage({type:"generated",payload:{samples:n}});break}case"getEmbeddings":{if(!d)return;const e=d.getEmbeddings();self.postMessage({type:"embeddings",payload:{embeddings:e}});break}case"getLossHistory":{if(!d)return;self.postMessage({type:"lossHistory",payload:{history:d.getLossHistory()}});break}case"getConfig":{if(!d)return;self.postMessage({type:"config",payload:d.getConfig()});break}}}})();
